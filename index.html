
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
      <link href="images/navbar.png" rel="icon" type="image/png" />
    <title>MARKET</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .cd {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .nl {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>
  </head>

  <body class="index" data-languages="[&quot;javascript&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" alt="Navbar" />
      </span>
    </a>
    <div class="toc-wrapper">
      <img src="images/market-logo.png" class="logo" alt="Market logo" />
        <div class="lang-selector">
              <a href="#" data-language-name="javascript">javascript</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc" class="toc-list-h1">
          <li>
            <a href="#introduction" class="toc-h1 toc-link" data-title="introduction">Introduction</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#documentation" class="toc-h2 toc-link" data-title="documentation">Documentation</a>
                  </li>
                  <li>
                    <a href="#frequently-asked-questions" class="toc-h2 toc-link" data-title="frequently-asked-questions">Frequently Asked Questions</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#background" class="toc-h1 toc-link" data-title="background">Background</a>
          </li>
          <li>
            <a href="#solidity-smart-contracts" class="toc-h1 toc-link" data-title="solidity-smart-contracts">Solidity Smart Contracts</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#market-contract" class="toc-h2 toc-link" data-title="market-contract">Market Contract</a>
                  </li>
                  <li>
                    <a href="#market-contract-oraclize" class="toc-h2 toc-link" data-title="market-contract-oraclize">Market Contract Oraclize</a>
                  </li>
                  <li>
                    <a href="#market-collateral-pool" class="toc-h2 toc-link" data-title="market-collateral-pool">Market Collateral Pool</a>
                  </li>
                  <li>
                    <a href="#orders" class="toc-h2 toc-link" data-title="orders">Orders</a>
                  </li>
                  <li>
                    <a href="#trading" class="toc-h2 toc-link" data-title="trading">Trading</a>
                  </li>
                  <li>
                    <a href="#market-contract-registry" class="toc-h2 toc-link" data-title="market-contract-registry">Market Contract Registry</a>
                  </li>
                  <li>
                    <a href="#mkt-tokens" class="toc-h2 toc-link" data-title="mkt-tokens">MKT Tokens</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#api" class="toc-h1 toc-link" data-title="api">API</a>
          </li>
          <li>
            <a href="#dapp" class="toc-h1 toc-link" data-title="dapp">DApp</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#contract-deployment" class="toc-h2 toc-link" data-title="contract-deployment">Contract Deployment</a>
                  </li>
                  <li>
                    <a href="#contract-explorer" class="toc-h2 toc-link" data-title="contract-explorer">Contract Explorer</a>
                  </li>
                  <li>
                    <a href="#test-query" class="toc-h2 toc-link" data-title="test-query">Test Query</a>
                  </li>
                  <li>
                    <a href="#simulated-exchange" class="toc-h2 toc-link" data-title="simulated-exchange">Simulated Exchange</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#faq-general" class="toc-h1 toc-link" data-title="faq-general">FAQ - General</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#what-is-a-derivative" class="toc-h2 toc-link" data-title="what-is-a-derivative">What is a derivative?</a>
                  </li>
                  <li>
                    <a href="#are-you-a-decentralized-exchange" class="toc-h2 toc-link" data-title="are-you-a-decentralized-exchange">Are you a decentralized exchange?</a>
                  </li>
                  <li>
                    <a href="#who-will-host-market-39-s-order-books" class="toc-h2 toc-link" data-title="who-will-host-market-s-order-books">Who will host MARKET's order books?</a>
                  </li>
                  <li>
                    <a href="#does-market-charge-a-fee-to-use-the-protocol" class="toc-h2 toc-link" data-title="does-market-charge-a-fee-to-use-the-protocol">Does MARKET charge a fee to use the protocol?</a>
                  </li>
                  <li>
                    <a href="#how-is-the-needed-collateral-for-an-open-position-calculated" class="toc-h2 toc-link" data-title="how-is-the-needed-collateral-for-an-open-position-calculated">How is the needed collateral for an open position calculated?</a>
                  </li>
                  <li>
                    <a href="#if-i-want-to-open-a-short-position-do-i-need-to-borrow-the-asset" class="toc-h2 toc-link" data-title="if-i-want-to-open-a-short-position-do-i-need-to-borrow-the-asset">If I want to open a short position do I need to borrow the asset?</a>
                  </li>
                  <li>
                    <a href="#when-is-my-collateral-returned-to-me-and-able-to-be-withdrawn" class="toc-h2 toc-link" data-title="when-is-my-collateral-returned-to-me-and-able-to-be-withdrawn">When is my collateral returned to me and able to be withdrawn?</a>
                  </li>
                  <li>
                    <a href="#what-happens-if-i-hold-an-open-position-through-contract-expiration" class="toc-h2 toc-link" data-title="what-happens-if-i-hold-an-open-position-through-contract-expiration">What happens if I hold an open position through contract expiration?</a>
                  </li>
                  <li>
                    <a href="#when-i-trade-out-of-an-open-position-how-is-my-profit-or-loss-allocated" class="toc-h2 toc-link" data-title="when-i-trade-out-of-an-open-position-how-is-my-profit-or-loss-allocated">When I trade out of an open position, how is my profit or loss allocated?</a>
                  </li>
                  <li>
                    <a href="#can-a-contract-be-created-based-on-a-different-blockhain-or-off-chain-asset" class="toc-h2 toc-link" data-title="can-a-contract-be-created-based-on-a-different-blockhain-or-off-chain-asset">Can a contract be created based on a different blockhain or off chain asset?</a>
                  </li>
                  <li>
                    <a href="#do-you-have-a-white-paper-available" class="toc-h2 toc-link" data-title="do-you-have-a-white-paper-available">Do you have a white paper available?</a>
                  </li>
                  <li>
                    <a href="#how-will-disputes-be-resolved" class="toc-h2 toc-link" data-title="how-will-disputes-be-resolved">How will disputes be resolved?</a>
                  </li>
                  <li>
                    <a href="#how-do-i-get-involved" class="toc-h2 toc-link" data-title="how-do-i-get-involved">How do I get involved?</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#faq-solidity-smart-contracts" class="toc-h1 toc-link" data-title="faq-solidity-smart-contracts">FAQ - Solidity Smart Contracts</a>
          </li>
          <li>
            <a href="#faq-api" class="toc-h1 toc-link" data-title="faq-api">FAQ - API</a>
          </li>
          <li>
            <a href="#faq-dapp" class="toc-h1 toc-link" data-title="faq-dapp">FAQ - DApp</a>
          </li>
      </div>
        <ul class="toc-footer">
            <li><a href='http://www.marketprotocol.io/'>MARKET Home</a></li>
            <li><a href='http://www.marketprotocol.io/'>MARKET DApp</a></li>
            <li><a href='http://www.marketprotocol.io/'>MARKET Whitepaper</a></li>
            <li><a href='https://github.com/MarketProject/'>MARKET GitHub</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id='introduction'>Introduction</h1>
<p>Welcome to MARKET! Here you will find documentation for our protocol and APIs.</p>
<h2 id='documentation'>Documentation</h2>
<ul>
<li><a href="#background">Background</a>: High level explanation of our protocol</li>
<li><a href="#smartcontracts">Smart Contracts</a>: The underlying MARKET smart contracts</li>
<li><a href="#api">API</a>:  Typescript API documentation</li>
<li><a href="#dapp">DApp</a>: Decentralized application allowing for easy MARKET contract deployment and exploration</li>
</ul>
<h2 id='frequently-asked-questions'>Frequently Asked Questions</h2>
<ul>
<li><a href="#faq-general">General FAQ</a></li>
<li><a href="#faq-solidity">Smart Contract FAQ</a></li>
<li><a href="#faq-api">API FAQ</a> </li>
<li><a href="#faq-dapp">DApp FAQ</a> </li>
</ul>
<h1 id='background'>Background</h1><h1 id='solidity-smart-contracts'>Solidity Smart Contracts</h1>
<p>All code for our smart contracts can be found <a href="https://github.com/MarketProject/MarketProtocol">here</a>. If you have any
issues to report please do so by opening an issue on <a href="https://github.com/MarketProject/MarketProtocol/issues">GitHub</a>.</p>
<h2 id='market-contract'>Market Contract</h2>
<blockquote>
<p>MarketContract constructor:</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="c1">/// @param contractName viewable name of this contract (BTC/ETH, LTC/ETH, etc)</span>
<span class="c1">/// @param marketTokenAddress address of our member token</span>
<span class="c1">/// @param baseTokenAddress address of the ERC20 token that will be used for collateral and pricing</span>
<span class="c1">/// @param contractSpecs array of unsigned integers including:</span>
<span class="c1">/// floorPrice minimum tradeable price of this contract, contract enters settlement if breached</span>
<span class="c1">/// capPrice maximum tradeable price of this contract, contract enters settlement if breached</span>
<span class="c1">/// priceDecimalPlaces number of decimal places to convert our queried price from a floating point to</span>
<span class="c1">/// an integer</span>
<span class="c1">/// qtyMultiplier multiply traded qty by this value from base units of collateral token.</span>
<span class="c1">/// expirationTimeStamp - seconds from epoch that this contract expires and enters settlement</span>
<span class="kd">function</span> <span class="nx">MarketContract</span><span class="p">(</span>
    <span class="nx">string</span> <span class="nx">contractName</span><span class="p">,</span>
    <span class="nx">address</span> <span class="nx">marketTokenAddress</span><span class="p">,</span>
    <span class="nx">address</span> <span class="nx">baseTokenAddress</span><span class="p">,</span>
    <span class="nx">uint</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="nx">contractSpecs</span>
<span class="p">)</span> <span class="kr">public</span> <span class="nx">payable</span>
<span class="p">{</span>
    <span class="nx">MKT_TOKEN_ADDRESS</span> <span class="o">=</span> <span class="nx">marketTokenAddress</span><span class="p">;</span>
    <span class="nx">MKT_TOKEN</span> <span class="o">=</span> <span class="nx">MarketToken</span><span class="p">(</span><span class="nx">marketTokenAddress</span><span class="p">);</span>
    <span class="nx">require</span><span class="p">(</span><span class="nx">MKT_TOKEN</span><span class="p">.</span><span class="nx">isBalanceSufficientForContractCreation</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">));</span>    <span class="c1">// creator must be MKT holder</span>
    <span class="nx">PRICE_FLOOR</span> <span class="o">=</span> <span class="nx">contractSpecs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">PRICE_CAP</span> <span class="o">=</span> <span class="nx">contractSpecs</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="nx">require</span><span class="p">(</span><span class="nx">PRICE_CAP</span> <span class="o">&gt;</span> <span class="nx">PRICE_FLOOR</span><span class="p">);</span>

    <span class="nx">PRICE_DECIMAL_PLACES</span> <span class="o">=</span> <span class="nx">contractSpecs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="nx">QTY_MULTIPLIER</span> <span class="o">=</span> <span class="nx">contractSpecs</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="nx">EXPIRATION</span> <span class="o">=</span> <span class="nx">contractSpecs</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="nx">require</span><span class="p">(</span><span class="nx">EXPIRATION</span> <span class="o">&gt;</span> <span class="nx">now</span><span class="p">);</span>

    <span class="nx">CONTRACT_NAME</span> <span class="o">=</span> <span class="nx">contractName</span><span class="p">;</span>
    <span class="nx">BASE_TOKEN_ADDRESS</span> <span class="o">=</span> <span class="nx">baseTokenAddress</span><span class="p">;</span>
    <span class="nx">BASE_TOKEN</span> <span class="o">=</span> <span class="nx">ERC20</span><span class="p">(</span><span class="nx">baseTokenAddress</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
<p>The <code>MarketContract</code> represents the main contract responsible for 
combining needed functionality for trading, settlement and position management.  Each <code>MarketContract</code> 
must be paired with a unique <code>MarketCollateralPool</code> (<a href="#collateral-pool">see below</a>) after instantiation in order to allow trading to become
enabled.  </p>

<p><code>MarketContract</code> is an abstract contract that will allow for implementing 
classes such as <code>MarketContractOraclize</code> to complete the needed top level functionality around oracle solutions.
We intend to expand our offering of oracle solutions offered in the near future.  If there are oracle services that
you would like to submit for possible inclusion in these future plans, please <a href="mailto:info@marketprotocol.io">contact</a> us</p>
<h3 id='oracle-pre-funding'>Oracle Pre-Funding</h3>
<p>The <code>Creator</code> of the <code>MarketContract</code> must pre-fund the contract with enough ETH in order to pay for the gas costs
associated with future oracle queries.  We intend to provide tools to help with this process, and in addition any
unused, pre-funded ETH can be reclaimed by the <code>Creator</code> upon contract expiration.</p>

<aside class="notice">
After linking of the <code>MarketContract</code> and the <code>MarketCollateralPool</code> is completed, the contract also must be added to 
the <code>MarketContractRegistry</code> in order to be fully functional for trading.
</aside>

<table><thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>contractName</td>
<td>viewable name of this contract, in the future we will implement suggested naming conventions</td>
</tr>
<tr>
<td>marketTokenAddress</td>
<td>address of the MKT deployed ERC20 token</td>
</tr>
<tr>
<td>baseTokenAddress</td>
<td>address of the ERC20 token that will be used for collateral</td>
</tr>
<tr>
<td>contractSpecs</td>
<td>array of unsigned integers including the below parameters</td>
</tr>
<tr>
<td>floorPrice</td>
<td>minimum tradeable price of this contract</td>
</tr>
<tr>
<td>capPrice</td>
<td>maximum tradeable price of this contract</td>
</tr>
<tr>
<td>expirationTimeStamp</td>
<td>seconds from epoch that this contract expires and enters settlement</td>
</tr>
</tbody></table>
<h2 id='market-contract-oraclize'>Market Contract Oraclize</h2>
<blockquote>
<p>MarketContractOraclize constructor:</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="c1">/// @param contractName viewable name of this contract (BTC/ETH, LTC/ETH, etc)</span>
<span class="c1">/// @param marketTokenAddress address of our member token</span>
<span class="c1">/// @param baseTokenAddress address of the ERC20 token that will be used for collateral and pricing</span>
<span class="c1">/// @param contractSpecs array of unsigned integers including:</span>
<span class="c1">/// floorPrice minimum tradeable price of this contract, contract enters settlement if breached</span>
<span class="c1">/// capPrice maximum tradeable price of this contract, contract enters settlement if breached</span>
<span class="c1">/// priceDecimalPlaces number of decimal places to convert our queried price from a floating point to</span>
<span class="c1">/// an integer</span>
<span class="c1">/// qtyMultiplier multiply traded qty by this value from base units of collateral token.</span>
<span class="c1">/// expirationTimeStamp - seconds from epoch that this contract expires and enters settlement</span>
<span class="c1">/// @param oracleDataSource a data-source such as "URL", "WolframAlpha", "IPFS"</span>
<span class="c1">/// see http://docs.oraclize.it/#ethereum-quick-start-simple-query</span>
<span class="c1">/// @param oracleQuery see http://docs.oraclize.it/#ethereum-quick-start-simple-query for examples</span>
<span class="c1">/// @param oracleQueryRepeatSeconds how often to repeat this callback to check for settlement, more frequent</span>
<span class="c1">/// queries require more gas and may not be needed.</span>
<span class="kd">function</span> <span class="nx">MarketContractOraclize</span><span class="p">(</span>
    <span class="nx">string</span> <span class="nx">contractName</span><span class="p">,</span>
    <span class="nx">address</span> <span class="nx">marketTokenAddress</span><span class="p">,</span>
    <span class="nx">address</span> <span class="nx">baseTokenAddress</span><span class="p">,</span>
    <span class="nx">uint</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="nx">contractSpecs</span><span class="p">,</span>
    <span class="nx">string</span> <span class="nx">oracleDataSource</span><span class="p">,</span>
    <span class="nx">string</span> <span class="nx">oracleQuery</span><span class="p">,</span>
    <span class="nx">uint</span> <span class="nx">oracleQueryRepeatSeconds</span>
<span class="p">)</span> <span class="nx">MarketContract</span><span class="p">(</span>
    <span class="nx">contractName</span><span class="p">,</span>
    <span class="nx">marketTokenAddress</span><span class="p">,</span>
    <span class="nx">baseTokenAddress</span><span class="p">,</span>
    <span class="nx">contractSpecs</span>
<span class="p">)</span>  <span class="kr">public</span> <span class="nx">payable</span>
<span class="p">{</span>
    <span class="nx">oraclize_setProof</span><span class="p">(</span><span class="nx">proofType_TLSNotary</span> <span class="o">|</span> <span class="nx">proofStorage_IPFS</span><span class="p">);</span>
    <span class="nx">ORACLE_DATA_SOURCE</span> <span class="o">=</span> <span class="nx">oracleDataSource</span><span class="p">;</span>
    <span class="nx">ORACLE_QUERY</span> <span class="o">=</span> <span class="nx">oracleQuery</span><span class="p">;</span>
    <span class="nx">ORACLE_QUERY_REPEAT</span> <span class="o">=</span> <span class="nx">oracleQueryRepeatSeconds</span><span class="p">;</span>
    <span class="nx">require</span><span class="p">(</span><span class="nx">checkSufficientStartingBalance</span><span class="p">(</span><span class="nx">EXPIRATION</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">now</span><span class="p">)));</span>
    <span class="nx">queryOracle</span><span class="p">();</span>  <span class="c1">// schedules recursive calls to oracle</span>
<span class="p">}</span>
</code></pre>
<p><code>MarketContractOraclize</code> is the first fully implemented <code>MarketContract</code> that has been built out.  Using 
<a href="http://www.oraclize.it/">Oraclize.it</a> allows for several different sources of truth in order to settle contracts.
More information on forming correct queries can 
be found in their <a href="http://docs.oraclize.it/#ethereum-quick-start-simple-query">documentation</a>.</p>

<p>Our <a href="https://app.marketprotocol.io">DApp</a> additionally has some help in formatting your queries correctly
and a test environment to ensure the queries are correct prior to contract deployment.</p>
<h3 id='additional-parameters'>Additional parameters</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>oracleDataSource</td>
<td>a data-source such as &quot;URL&quot;, &quot;WolframAlpha&quot;, &quot;IPFS&quot;</td>
</tr>
<tr>
<td>oracleQuery</td>
<td>properly formatted Oraclize.it query</td>
</tr>
<tr>
<td>oracleQueryRepeatSeconds</td>
<td>how often to repeat the query and check for settlement, more frequent calling requires more pre-funding</td>
</tr>
</tbody></table>
<h2 id='market-collateral-pool'>Market Collateral Pool</h2>
<blockquote>
<p>MarketCollateralPool constructor:</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="c1">/// @dev instantiates a collateral pool that is unique to the supplied address of a MarketContract. This pairing</span>
<span class="c1">/// is 1:1</span>
<span class="c1">/// @param marketContractAddress deployed address of a MarketContract</span>
<span class="kd">function</span> <span class="nx">MarketCollateralPool</span><span class="p">(</span><span class="nx">address</span> <span class="nx">marketContractAddress</span><span class="p">)</span> <span class="nx">Linkable</span><span class="p">(</span><span class="nx">marketContractAddress</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="nx">MKT_CONTRACT</span> <span class="o">=</span> <span class="nx">MarketContract</span><span class="p">(</span><span class="nx">marketContractAddress</span><span class="p">);</span>
    <span class="nx">MKT_TOKEN_ADDRESS</span> <span class="o">=</span> <span class="nx">MKT_CONTRACT</span><span class="p">.</span><span class="nx">MKT_TOKEN_ADDRESS</span><span class="p">();</span>
    <span class="nx">MKT_TOKEN</span> <span class="o">=</span> <span class="nx">MarketToken</span><span class="p">(</span><span class="nx">MKT_TOKEN_ADDRESS</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
<p>The <code>MarketCollateralPool</code> is a contract controlled by a specific <code>MarketContract</code>.  It holds users balances, 
locked collateral balances and open positions accounting.  These balances and positions are unique to the linked 
<code>MarketContract</code> and a user must deposit funds for each <code>MarketContract</code> they intend to trade.  The ERC20 Token
specified are the only accepted form of funding or collateralization.</p>
<h3 id='depositing-funds-for-trading'>Depositing funds for trading</h3>
<blockquote>
<p>depositTokensForTrading function</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="c1">/// @notice deposits tokens to the smart contract to fund the user account and provide needed tokens for collateral</span>
<span class="c1">/// pool upon trade matching.</span>
<span class="c1">/// @param depositAmount qty of ERC20 tokens to deposit to the smart contract to cover open orders and collateral</span>
<span class="kd">function</span> <span class="nx">depositTokensForTrading</span><span class="p">(</span><span class="nx">uint256</span> <span class="nx">depositAmount</span><span class="p">)</span> <span class="nx">external</span> <span class="p">{</span>
    <span class="c1">// user must call approve!</span>
    <span class="nx">require</span><span class="p">(</span><span class="nx">MKT_TOKEN</span><span class="p">.</span><span class="nx">isUserEnabledForContract</span><span class="p">(</span><span class="nx">MKT_CONTRACT</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">));</span>
    <span class="nx">uint256</span> <span class="nx">balanceAfterDeposit</span> <span class="o">=</span> <span class="nx">userAddressToAccountBalance</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">].</span><span class="nx">add</span><span class="p">(</span><span class="nx">depositAmount</span><span class="p">);</span>
    <span class="nx">ERC20</span><span class="p">(</span><span class="nx">MKT_CONTRACT</span><span class="p">.</span><span class="nx">BASE_TOKEN_ADDRESS</span><span class="p">()).</span><span class="nx">safeTransferFrom</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">depositAmount</span><span class="p">);</span>
    <span class="nx">userAddressToAccountBalance</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balanceAfterDeposit</span><span class="p">;</span>
    <span class="nx">UpdatedUserBalance</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">balanceAfterDeposit</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
<p>Funds deposited by a user are allocated to their address&#39;s account balance until a point at which a new position is 
opened and the funds then become allocated to <code>collateralPoolBalance</code> and are locked until the user exits their
position or the contract expires.  In this way, all open positions are always fully collateralized eliminating any
counter party risk and ensuring the solvency of the contract.</p>
<h3 id='calculating-needed-collateral-and-maximum-possible-loss'>Calculating needed collateral and maximum possible loss</h3>
<blockquote>
<p>calculateNeededCollateral function</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="c1">/// @notice determines the amount of needed collateral for a given position (qty and price)</span>
<span class="c1">/// @param priceFloor lowest price the contract is allowed to trade before expiration</span>
<span class="c1">/// @param priceCap highest price the contract is allowed to trade before expiration</span>
<span class="c1">/// @param qtyMultiplier multiplier for qty from base units</span>
<span class="c1">/// @param qty signed integer corresponding to the traded quantity</span>
<span class="c1">/// @param price of the trade</span>
<span class="kd">function</span> <span class="nx">calculateNeededCollateral</span><span class="p">(</span>
    <span class="nx">uint</span> <span class="nx">priceFloor</span><span class="p">,</span>
    <span class="nx">uint</span> <span class="nx">priceCap</span><span class="p">,</span>
    <span class="nx">uint</span> <span class="nx">qtyMultiplier</span><span class="p">,</span>
    <span class="kr">int</span> <span class="nx">qty</span><span class="p">,</span>
    <span class="nx">uint</span> <span class="nx">price</span>
<span class="p">)</span> <span class="nx">pure</span> <span class="nx">internal</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">uint</span> <span class="nx">neededCollateral</span><span class="p">)</span>
<span class="p">{</span>

    <span class="nx">uint</span> <span class="nx">maxLoss</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">qty</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>   <span class="c1">// this qty is long, calculate max loss from entry price to floor</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">price</span> <span class="o">&lt;=</span> <span class="nx">priceFloor</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">maxLoss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">maxLoss</span> <span class="o">=</span> <span class="nx">subtract</span><span class="p">(</span><span class="nx">price</span><span class="p">,</span> <span class="nx">priceFloor</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// this qty is short, calculate max loss from entry price to ceiling;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">price</span> <span class="o">&gt;=</span> <span class="nx">priceCap</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">maxLoss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">maxLoss</span> <span class="o">=</span> <span class="nx">subtract</span><span class="p">(</span><span class="nx">priceCap</span><span class="p">,</span> <span class="nx">price</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">neededCollateral</span> <span class="o">=</span> <span class="nx">maxLoss</span> <span class="o">*</span> <span class="nx">abs</span><span class="p">(</span><span class="nx">qty</span><span class="p">)</span> <span class="o">*</span> <span class="nx">qtyMultiplier</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p>The amount of funds that are allocated to the <code>collateralPoolBalance</code> upon entering a trade is defined by that positions
maximum possible loss.  </p>

<p>All positions are always fully collateralized, meaning the maximum possible loss for a position is the required 
amount of collateral to open that position. This can be calculated from the <code>price</code> and <code>qty</code> of the 
position and the defined specifications of the <code>MarketContract</code>.  </p>

<p>For a buyer, the maximum possible loss is calculated as the <code>price</code> of the 
trade minus the <code>priceFloor</code> times the qty transacted. Conversely, if you are opening a short position the maximum 
loss is calculated as <code>priceCap</code> minus the price of the trade, multiplied by the <code>qty</code> transacted. Upon filling an order 
both parties commit their respective maximum loss to the collateral pool.</p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>priceFloor</td>
<td>as defined in the <code>MarketContract</code></td>
</tr>
<tr>
<td>priceCap</td>
<td>as defined in the <code>MarketContract</code></td>
</tr>
<tr>
<td>qtyMultiplier</td>
<td>as defined in the <code>MarketContract</code></td>
</tr>
<tr>
<td>qty</td>
<td>signed integer corresponding to the traded quantity</td>
</tr>
<tr>
<td>price</td>
<td>agreed upon execution price</td>
</tr>
</tbody></table>
<h3 id='withdrawing-funds'>Withdrawing funds</h3>
<blockquote>
<p>withdrawTokens function</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="c1">/// @notice removes token from users trading account</span>
<span class="c1">/// @param withdrawAmount qty of token to attempt to withdraw</span>
<span class="kd">function</span> <span class="nx">withdrawTokens</span><span class="p">(</span><span class="nx">uint256</span> <span class="nx">withdrawAmount</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="c1">//require(userAddressToAccountBalance[msg.sender] &gt;= withdrawAmount);  subtract call below will enforce this</span>
    <span class="nx">uint256</span> <span class="nx">balanceAfterWithdrawal</span> <span class="o">=</span> <span class="nx">userAddressToAccountBalance</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">].</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">withdrawAmount</span><span class="p">);</span>
    <span class="nx">userAddressToAccountBalance</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span> <span class="o">=</span> <span class="nx">balanceAfterWithdrawal</span><span class="p">;</span>   <span class="c1">// update balance before external call!</span>
    <span class="nx">ERC20</span><span class="p">(</span><span class="nx">MKT_CONTRACT</span><span class="p">.</span><span class="nx">BASE_TOKEN_ADDRESS</span><span class="p">()).</span><span class="nx">safeTransfer</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">withdrawAmount</span><span class="p">);</span>
    <span class="nx">UpdatedUserBalance</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">balanceAfterWithdrawal</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
<p>At any time, tokens that are not allocated to an open position held by the user, are able to be withdrawn.</p>

<p>Upon exiting a position funds are returned to the user&#39;s account balance, net of any profit or loss.  Similarly,
if the contract expires with the user maintaining an open position, their position settles to the final settlement
price of the contract and funds are then eligible for immediate withdraw.</p>
<h2 id='orders'>Orders</h2>
<blockquote>
<p>MARKET&#39;s Order struct</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="nx">struct</span> <span class="nx">Order</span> <span class="p">{</span>
    <span class="nx">address</span> <span class="nx">maker</span><span class="p">;</span>
    <span class="nx">address</span> <span class="nx">taker</span><span class="p">;</span>
    <span class="nx">address</span> <span class="nx">feeRecipient</span><span class="p">;</span>
    <span class="nx">uint</span> <span class="nx">makerFee</span><span class="p">;</span>
    <span class="nx">uint</span> <span class="nx">takerFee</span><span class="p">;</span>
    <span class="nx">uint</span> <span class="nx">price</span><span class="p">;</span>
    <span class="nx">uint</span> <span class="nx">expirationTimeStamp</span><span class="p">;</span>
    <span class="kr">int</span> <span class="nx">qty</span><span class="p">;</span>
    <span class="nx">bytes32</span> <span class="nx">orderHash</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>Generating and confirming Order signatures</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="c1">/// @notice creates the hash for the given order parameters.</span>
<span class="c1">/// @param contractAddress address of the calling contract, orders are unique to each contract</span>
<span class="c1">/// @param orderAddresses array of 3 address. maker, taker, and feeRecipient</span>
<span class="c1">/// @param unsignedOrderValues array of 5 unsigned integers. makerFee, takerFee, price, expirationTimeStamp and salt</span>
<span class="c1">/// @param orderQty signed qty of the original order.</span>
<span class="kd">function</span> <span class="nx">createOrderHash</span><span class="p">(</span>
    <span class="nx">address</span> <span class="nx">contractAddress</span><span class="p">,</span>
    <span class="nx">address</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="nx">orderAddresses</span><span class="p">,</span>
    <span class="nx">uint</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="nx">unsignedOrderValues</span><span class="p">,</span>
    <span class="kr">int</span> <span class="nx">orderQty</span>
<span class="p">)</span> <span class="kr">public</span> <span class="nx">pure</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">bytes32</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">keccak256</span><span class="p">(</span>
        <span class="nx">contractAddress</span><span class="p">,</span>
        <span class="nx">orderAddresses</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">orderAddresses</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="nx">orderAddresses</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="nx">unsignedOrderValues</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">unsignedOrderValues</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="nx">unsignedOrderValues</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="nx">unsignedOrderValues</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="nx">unsignedOrderValues</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
        <span class="nx">orderQty</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="c1">/// @notice confirms hash originated from signer</span>
<span class="c1">/// @param signerAddress - address of order originator</span>
<span class="c1">/// @param hash - original order hash</span>
<span class="c1">/// @param v order signature</span>
<span class="c1">/// @param r order signature</span>
<span class="c1">/// @param s order signature</span>
<span class="kd">function</span> <span class="nx">isValidSignature</span><span class="p">(</span>
    <span class="nx">address</span> <span class="nx">signerAddress</span><span class="p">,</span>
    <span class="nx">bytes32</span> <span class="nx">hash</span><span class="p">,</span>
    <span class="nx">uint8</span> <span class="nx">v</span><span class="p">,</span>
    <span class="nx">bytes32</span> <span class="nx">r</span><span class="p">,</span>
    <span class="nx">bytes32</span> <span class="nx">s</span>
<span class="p">)</span> <span class="kr">public</span> <span class="nx">pure</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">bool</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">signerAddress</span> <span class="o">==</span> <span class="nx">ecrecover</span><span class="p">(</span>
        <span class="nx">keccak256</span><span class="p">(</span><span class="s2">"\x19Ethereum Signed Message:\n32"</span><span class="p">,</span> <span class="nx">hash</span><span class="p">),</span>
        <span class="nx">v</span><span class="p">,</span>
        <span class="nx">r</span><span class="p">,</span>
        <span class="nx">s</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre>
<p>MARKET utilizes off chain orders to reduce the number of needed transactions that must occur on the blockchain.   Third 
party Nodes will provide order book hosting and aggregation services on top of the protocol to facilitate liquidity.
Orders however are cryptographically signed to ensure no manipulation and facilitate trust-less executions.</p>

<p>Makers create orders and sign them (making liquidity), while takers select signed orders 
to trade against (taking liquidity).  </p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>maker</td>
<td>address of user who originated and signed this order</td>
</tr>
<tr>
<td>taker</td>
<td>address of counter-party to fill order or <code>null</code> to allow any counter-party</td>
</tr>
<tr>
<td>feeRecipient</td>
<td>address of fee recipient node, if any (MARKET does not charge any fees, but nodes may)</td>
</tr>
<tr>
<td>makerFee</td>
<td>fee to paid by the maker in MKT tokens to the <code>feeRecipient</code></td>
</tr>
<tr>
<td>takerFee</td>
<td>fee to paid by the taker in MKT tokens to the <code>feeRecipient</code></td>
</tr>
<tr>
<td>price</td>
<td>agreed upon execution price</td>
</tr>
<tr>
<td>qty</td>
<td>agreed upon execution qty</td>
</tr>
<tr>
<td>orderHash</td>
<td>hash created by maker to ensure all order parameters are valid and originated from <code>maker</code></td>
</tr>
</tbody></table>

<p>A maker creates an order with the specified parameters and calls <code>createOrderHash</code> that is transmitted 
along with the order.  Any part can verify the veracity of the hash with <code>isValidSignature</code> which will match the
signer&#39;s address if all parameters of the order are valid.</p>

<p>Makers may cancel an order at any time, unfortunately this transaction happens on chain and will require gas to complete.
Alternatively, an <code>Order</code> can be created with an <code>expirationTimeStamp</code> expiring the order automatically without the
additional gas cost. </p>
<h2 id='trading'>Trading</h2><pre class="highlight javascript tab-javascript"><code>
<span class="c1">// @notice called by a participant wanting to trade a specific order</span>
<span class="c1">/// @param orderAddresses - maker, taker and feeRecipient addresses</span>
<span class="c1">/// @param unsignedOrderValues makerFee, takerFree, price, expirationTimeStamp, and salt (for hashing)</span>
<span class="c1">/// @param orderQty quantity of the order</span>
<span class="c1">/// @param qtyToFill quantity taker is willing to fill of original order(max)</span>
<span class="c1">/// @param v order signature</span>
<span class="c1">/// @param r order signature</span>
<span class="c1">/// @param s order signature</span>
<span class="kd">function</span> <span class="nx">tradeOrder</span><span class="p">(</span>
    <span class="nx">address</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="nx">orderAddresses</span><span class="p">,</span>
    <span class="nx">uint</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="nx">unsignedOrderValues</span><span class="p">,</span>
    <span class="kr">int</span> <span class="nx">orderQty</span><span class="p">,</span>
    <span class="kr">int</span> <span class="nx">qtyToFill</span><span class="p">,</span>
    <span class="nx">uint8</span> <span class="nx">v</span><span class="p">,</span>
    <span class="nx">bytes32</span> <span class="nx">r</span><span class="p">,</span>
    <span class="nx">bytes32</span> <span class="nx">s</span>
<span class="p">)</span> <span class="nx">external</span> <span class="nx">returns</span> <span class="p">(</span><span class="kr">int</span> <span class="nx">filledQty</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nx">require</span><span class="p">(</span><span class="nx">isCollateralPoolContractLinked</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isSettled</span><span class="p">);</span> <span class="c1">// no trading past settlement</span>
    <span class="nx">require</span><span class="p">(</span><span class="nx">orderQty</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">qtyToFill</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">orderQty</span><span class="p">.</span><span class="nx">isSameSign</span><span class="p">(</span><span class="nx">qtyToFill</span><span class="p">));</span>   <span class="c1">// no zero trades, sings match</span>
    <span class="nx">require</span><span class="p">(</span><span class="nx">MKT_TOKEN</span><span class="p">.</span><span class="nx">isUserEnabledForContract</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">));</span>
    <span class="nx">OrderLib</span><span class="p">.</span><span class="nx">Order</span> <span class="nx">memory</span> <span class="nx">order</span> <span class="o">=</span> <span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">createOrder</span><span class="p">(</span><span class="nx">orderAddresses</span><span class="p">,</span> <span class="nx">unsignedOrderValues</span><span class="p">,</span> <span class="nx">orderQty</span><span class="p">);</span>
    <span class="nx">require</span><span class="p">(</span><span class="nx">MKT_TOKEN</span><span class="p">.</span><span class="nx">isUserEnabledForContract</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">order</span><span class="p">.</span><span class="nx">maker</span><span class="p">));</span>

    <span class="c1">// taker can be anyone, or specifically the caller!</span>
    <span class="nx">require</span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">taker</span> <span class="o">==</span> <span class="nx">address</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="nx">order</span><span class="p">.</span><span class="nx">taker</span> <span class="o">==</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">);</span>
    <span class="c1">// do not allow self trade</span>
    <span class="nx">require</span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">maker</span> <span class="o">!=</span> <span class="nx">address</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">order</span><span class="p">.</span><span class="nx">maker</span> <span class="o">!=</span> <span class="nx">order</span><span class="p">.</span><span class="nx">taker</span><span class="p">);</span>
    <span class="nx">require</span><span class="p">(</span>
        <span class="nx">order</span><span class="p">.</span><span class="nx">maker</span><span class="p">.</span><span class="nx">isValidSignature</span><span class="p">(</span>
            <span class="nx">order</span><span class="p">.</span><span class="nx">orderHash</span><span class="p">,</span>
            <span class="nx">v</span><span class="p">,</span>
            <span class="nx">r</span><span class="p">,</span>
            <span class="nx">s</span>
    <span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">now</span> <span class="o">&gt;=</span> <span class="nx">order</span><span class="p">.</span><span class="nx">expirationTimeStamp</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">Error</span><span class="p">(</span><span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">ORDER_EXPIRED</span><span class="p">,</span> <span class="nx">order</span><span class="p">.</span><span class="nx">orderHash</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kr">int</span> <span class="nx">remainingQty</span> <span class="o">=</span> <span class="nx">orderQty</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">getQtyFilledOrCancelledFromOrder</span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">orderHash</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">remainingQty</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// there is no qty remaining  - cannot fill!</span>
        <span class="nb">Error</span><span class="p">(</span><span class="nx">ErrorCodes</span><span class="p">.</span><span class="nx">ORDER_DEAD</span><span class="p">,</span> <span class="nx">order</span><span class="p">.</span><span class="nx">orderHash</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">filledQty</span> <span class="o">=</span> <span class="nx">MathLib</span><span class="p">.</span><span class="nx">absMin</span><span class="p">(</span><span class="nx">remainingQty</span><span class="p">,</span> <span class="nx">qtyToFill</span><span class="p">);</span>
    <span class="nx">marketCollateralPool</span><span class="p">.</span><span class="nx">updatePositions</span><span class="p">(</span>
        <span class="nx">order</span><span class="p">.</span><span class="nx">maker</span><span class="p">,</span>
        <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span>
        <span class="nx">filledQty</span><span class="p">,</span>
        <span class="nx">order</span><span class="p">.</span><span class="nx">price</span>
    <span class="p">);</span>
    <span class="nx">orderMappings</span><span class="p">.</span><span class="nx">addFilledQtyToOrder</span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">orderHash</span><span class="p">,</span> <span class="nx">filledQty</span><span class="p">);</span>

    <span class="nx">uint</span> <span class="nx">paidMakerFee</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">uint</span> <span class="nx">paidTakerFee</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">feeRecipient</span> <span class="o">!=</span> <span class="nx">address</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// we need to transfer fees to recipient</span>
        <span class="nx">uint</span> <span class="nx">filledAbsQty</span> <span class="o">=</span> <span class="nx">filledQty</span><span class="p">.</span><span class="nx">abs</span><span class="p">();</span>
        <span class="nx">uint</span> <span class="nx">orderAbsQty</span> <span class="o">=</span> <span class="nx">filledQty</span><span class="p">.</span><span class="nx">abs</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">makerFee</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">paidMakerFee</span> <span class="o">=</span> <span class="nx">order</span><span class="p">.</span><span class="nx">makerFee</span><span class="p">.</span><span class="nx">divideFractional</span><span class="p">(</span><span class="nx">filledAbsQty</span><span class="p">,</span> <span class="nx">orderAbsQty</span><span class="p">);</span>
            <span class="nx">MKT_TOKEN</span><span class="p">.</span><span class="nx">safeTransferFrom</span><span class="p">(</span>
                <span class="nx">order</span><span class="p">.</span><span class="nx">maker</span><span class="p">,</span>
                <span class="nx">order</span><span class="p">.</span><span class="nx">feeRecipient</span><span class="p">,</span>
                <span class="nx">paidMakerFee</span>
            <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">takerFee</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">paidTakerFee</span> <span class="o">=</span> <span class="nx">order</span><span class="p">.</span><span class="nx">takerFee</span><span class="p">.</span><span class="nx">divideFractional</span><span class="p">(</span><span class="nx">filledAbsQty</span><span class="p">,</span> <span class="nx">orderAbsQty</span><span class="p">);</span>
            <span class="nx">MKT_TOKEN</span><span class="p">.</span><span class="nx">safeTransferFrom</span><span class="p">(</span>
                <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span>
                <span class="nx">order</span><span class="p">.</span><span class="nx">feeRecipient</span><span class="p">,</span>
                <span class="nx">paidTakerFee</span>
            <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">OrderFilled</span><span class="p">(</span>
        <span class="nx">order</span><span class="p">.</span><span class="nx">maker</span><span class="p">,</span>
        <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span>
        <span class="nx">order</span><span class="p">.</span><span class="nx">feeRecipient</span><span class="p">,</span>
        <span class="nx">filledQty</span><span class="p">,</span>
        <span class="nx">paidMakerFee</span><span class="p">,</span>
        <span class="nx">paidTakerFee</span><span class="p">,</span>
        <span class="nx">order</span><span class="p">.</span><span class="nx">orderHash</span>
    <span class="p">);</span>

    <span class="k">return</span> <span class="nx">filledQty</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p>When a <code>taker</code> finds an order they would like to transact against, they call the <code>tradeOrder</code> function. </p>

<p>This function, verifies the order signature, ensures all contracts and users are allowed to trade and if successful
handles the accounting with the associated resulting fills (either open a new position, or perhaps, closing out an 
existing open position). </p>

<p>A <code>taker</code> is not required to fill the entire <code>maker</code> order and specifies the <code>qty</code> they are willing to transact.  The
price however is static as set and signed by the <code>maker</code>.</p>
<h2 id='market-contract-registry'>Market Contract Registry</h2>
<p>A registry will exist of all MARKET contracts that are approved for trading.  Eventually there will be some
mechanism for the community to flag contracts that are not valid, or reasonable for removal from the white list.  At
first this may be more centralized, but eventually the goal is to have a fully decentralized community in charge of 
such matters.</p>
<h2 id='mkt-tokens'>MKT Tokens</h2>
<p>MKT Tokens are the lifeblood of the MARKET ecosystem.  All fees charged by nodes will be transacted in MKT and additionally
anyone who wishes to create a new <code>MarketContract</code> will be forced to have some minimum balance of MKT. Finally, for every
<code>MarketContract</code> a user desires to trade, some amount of MKT must be locked to enable access to that contract.  These
can be unlocked at any time the user wishes to stop trading that <code>MarketContract</code>.   </p>
<h1 id='api'>API</h1>
<p>Coming Soon...</p>
<h1 id='dapp'>DApp</h1><h2 id='contract-deployment'>Contract Deployment</h2><h2 id='contract-explorer'>Contract Explorer</h2><h2 id='test-query'>Test Query</h2><h2 id='simulated-exchange'>Simulated Exchange</h2><h1 id='faq-general'>FAQ - General</h1><h3 id='what-is-a-derivative'>What is a derivative?</h3>
<p>A derivative represents a contract between a buyer and a seller. The value is derived from on an underlying asset or assets. Common derivatives use stocks, commodities, currencies, bonds, or interest rates as the underlying asset for the contract.</p>
<h3 id='are-you-a-decentralized-exchange'>Are you a decentralized exchange?</h3>
<p>No, MARKET is a protocol to enable the trading of decentralized derivative like contracts.  Third parties will write the application layers on top of the protocol and we hope to create an API layer to facilitate this as well. </p>
<h3 id='who-will-host-market-39-s-order-books'>Who will host MARKET&#39;s order books?</h3>
<p>Third party order book hosts, called nodes will be provided with an API that easy allows them to host an order book.  Nodes, in turn may charge fees for the services they provide.  These fee&#39;s are not determined by MARKET and are set directly by the node.</p>
<h3 id='does-market-charge-a-fee-to-use-the-protocol'>Does MARKET charge a fee to use the protocol?</h3>
<p>MARKET doesn&#39;t charge any fees.  Nodes however may set a fee for their services of hosting order books.</p>
<h3 id='how-is-the-needed-collateral-for-an-open-position-calculated'>How is the needed collateral for an open position calculated?</h3>
<p>All positions are always fully collateralized, meaning the maximum possible loss for a position is the required amount of collateral to open that position. For a buyer, the maximum possible loss is calculated as the price of the trade minus the <code>PRICE_FLOOR</code> times the qty transacted.  Conversely, if you are opening a short position the maximum loss is calculated as <code>PRICE_CAP</code> minus the price of the trade, multiplied by the qty transacted.  Upon filling an order both parties commit their respective maximum loss to the collateral pool.</p>
<h3 id='if-i-want-to-open-a-short-position-do-i-need-to-borrow-the-asset'>If I want to open a short position do I need to borrow the asset?</h3>
<p>No, there is no borrowing, fees to be paid, or locates to deal with for shorting.  Due to the unique nature of our derivative like contracts, a trader is able to open a short position without owning the underlying asset.  This is similar to how financial futures work, where a seller of the SP500 futures, doesn&#39;t need to own, locate, or borrow the SP500 in order to gain the short price exposure to the SP500.</p>
<h3 id='when-is-my-collateral-returned-to-me-and-able-to-be-withdrawn'>When is my collateral returned to me and able to be withdrawn?</h3>
<p>Collateral is credited to a users address and able to be withdrawn upon expiration of the contract or if the user trades out of their open position.  For instance, if a trader holding a long open position, sells to close out that position prior to expiration, they will immediately be able to withdraw the collateral associated (plus or minus any profit or loss) with their trade.</p>
<h3 id='what-happens-if-i-hold-an-open-position-through-contract-expiration'>What happens if I hold an open position through contract expiration?</h3>
<p>Upon expiration, the contract will reach a settlement price via the agreed upon oracle solution.  At this point, all funds will be able to be withdrawn for all open positions.  The amount of collateral that is credited back to the user will be determined by their execution price and the settlement price of the contract.  Note, that there will probably be some short delay between contract expiration and the settlement period to allow for disputes to be raised.</p>
<h3 id='when-i-trade-out-of-an-open-position-how-is-my-profit-or-loss-allocated'>When I trade out of an open position, how is my profit or loss allocated?</h3>
<p>When a position is closed, the appropriate amount of funds are allocated back to the user and are immediately available for withdrawal from the smart contract.  If the trade that was made was profitable, more funds will be available for withdrawal than originally posted, and if the trade represented a loser for the user, less funds than originally posted would now be available for withdrawal.  As an example, let us imagine a contract with a <code>PRICE_FLOOR</code> of 50 and a <code>PRICE_CAP</code> of 150 using Token A as collateral.  Bob enters into a long position for a qty of 1 at a price of 85.  At this point 35 units of Token A would be committed to the collateral pool (representing his max possible loss).  Later, Bob exits his position by selling at a price of 95.  The amount of Token A now allocated to Bob&#39;s account is 45 (35 of which is his original collateral and 10 of which represents his profit from his trade) and is now able to be withdrawn from the smart contract if Bob so wishes. </p>
<h3 id='can-a-contract-be-created-based-on-a-different-blockhain-or-off-chain-asset'>Can a contract be created based on a different blockhain or off chain asset?</h3>
<p>Yes, by using oracle solutions for settlement users can create contracts for any type of real world asset such as the SP500, or cross chain asset prices like Bitcoin or Monero. This opens endless opportunities and diversification for the holders of ERC20 tokens who do not want to convert into fiat but want to gain market exposure to non digital or cross chain assets.  </p>
<h3 id='do-you-have-a-white-paper-available'>Do you have a white paper available?</h3>
<p>We do not currently have a public white paper available.  We are working very hard to make sure the internal documents we have are fit for public consumption and will be releasing it as soon as possible.</p>
<h3 id='how-will-disputes-be-resolved'>How will disputes be resolved?</h3>
<p>This is an area of active research and discussion.  We would love for community feedback to help shape the process.  Our current working theory is that once a contract settlement enters into a disputed state, that a second attempt may be made to use the originally agreed upon oracle, and if that still fails to enter into a crowd sourced voting from community members that are incentivized for a fair resolution.  We do anticipate that even in the best of circumstances oracle solutions will fail, or receive bad data.  The problem of bad or inaccurate market data is not new or unique in the world of finance, but the need to resolve these problems when they arise in a trust-less manner will be essential. </p>
<h3 id='how-do-i-get-involved'>How do I get involved?</h3>
<p>We are actively looking to expand our team. For more info please send an email to info@marketprotocol.io</p>
<h1 id='faq-solidity-smart-contracts'>FAQ - Solidity Smart Contracts</h1><h1 id='faq-api'>FAQ - API</h1><h1 id='faq-dapp'>FAQ - DApp</h1>
      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="javascript">javascript</a>
          </div>
      </div>
    </div>
  </body>
</html>
